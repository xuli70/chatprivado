<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <title>Debug Simple - Admin</title>
    <style>
        body { font-family: Arial, sans-serif; padding: 20px; }
        button { padding: 10px 20px; margin: 5px; }
        #output { background: #f0f0f0; padding: 10px; margin-top: 20px; white-space: pre-wrap; }
    </style>
</head>
<body>
    <h1>ğŸ”§ Debug Sistema Admin</h1>
    
    <h2>Paso 1: Crear datos de prueba</h2>
    <button onclick="crearSalas()">ğŸ—ï¸ Crear 3 Salas de Prueba</button>
    <button onclick="mostrarStorage()">ğŸ’¾ Ver localStorage</button>
    
    <h2>Paso 2: Probar funciones</h2>
    <button onclick="probarGetAllRooms()">ğŸ“‹ Test getAllRooms()</button>
    <button onclick="probarGetAllRoomsAdmin()">ğŸ“‹ Test getAllRooms(true)</button>
    
    <h2>Paso 3: Testing Modal (EL PROBLEMA)</h2>
    <button onclick="activarAdmin()">ğŸ”‘ Activar Admin</button>
    <button onclick="testModalClick1()">1ï¸âƒ£ Primer Click Modal</button>
    <button onclick="testModalClick2()">2ï¸âƒ£ Segundo Click Modal</button>
    <button onclick="testModalClick3()">3ï¸âƒ£ Tercer Click Modal</button>
    <button onclick="inspeccionarModal()">ğŸ” Inspeccionar Modal</button>
    
    <h2>Paso 4: Limpiar</h2>
    <button onclick="limpiar()">ğŸ—‘ï¸ Limpiar Todo</button>
    
    <div id="output"></div>

    <!-- Modal copiado del index.html -->
    <div id="confirmModal" class="modal hidden">
        <div class="modal-content">
            <div class="modal-header">
                <h3 id="confirmTitle">Confirmar acciÃ³n</h3>
            </div>
            <div class="modal-body">
                <p id="confirmMessage">Â¿EstÃ¡s seguro?</p>
            </div>
            <div class="modal-footer">
                <button id="cancelBtn" class="btn btn--outline">Cancelar</button>
                <button id="confirmBtn" class="btn btn--primary">Confirmar</button>
            </div>
        </div>
    </div>

    <script src="env.js"></script>
    <script src="supabase-client.js"></script>
    <script src="app.js"></script>
    <script>
        const output = document.getElementById('output');
        const app = new AnonymousChatApp();
        
        function log(msg) {
            output.textContent += new Date().toLocaleTimeString() + ' - ' + msg + '\n';
            console.log(msg);
        }
        
        function crearSalas() {
            const salas = [
                {
                    id: 'TEST01',
                    creator: 'Admin',
                    question: 'Sala admin activa',
                    createdAt: new Date().toISOString(),
                    expiresAt: new Date(Date.now() + 7200000).toISOString(),
                    messageLimit: 50,
                    messages: [{
                        id: Date.now(),
                        text: 'Mensaje inicial',
                        isAnonymous: false,
                        author: 'Admin',
                        timestamp: new Date().toISOString(),
                        votes: { likes: 0, dislikes: 0 }
                    }]
                },
                {
                    id: 'TEST02',
                    creator: 'Usuario',
                    question: 'Sala normal expirada',
                    createdAt: new Date(Date.now() - 10000000).toISOString(),
                    expiresAt: new Date(Date.now() - 1000000).toISOString(),
                    messageLimit: 50,
                    messages: []
                },
                {
                    id: 'TEST03',
                    creator: 'Test',
                    question: 'Sala reciente',
                    createdAt: new Date().toISOString(),
                    expiresAt: new Date(Date.now() + 7200000).toISOString(),
                    messageLimit: 50,
                    messages: []
                }
            ];
            
            salas.forEach(sala => {
                localStorage.setItem(`room_${sala.id}`, JSON.stringify(sala));
            });
            
            log(`âœ… Creadas ${salas.length} salas de prueba`);
            mostrarStorage();
        }
        
        function mostrarStorage() {
            const keys = Object.keys(localStorage);
            const roomKeys = keys.filter(k => k.startsWith('room_'));
            log(`ğŸ’¾ localStorage tiene ${roomKeys.length} salas:`);
            roomKeys.forEach(key => {
                try {
                    const room = JSON.parse(localStorage.getItem(key));
                    const expired = new Date() > new Date(room.expiresAt) ? ' (EXPIRADA)' : ' (ACTIVA)';
                    log(`  - ${key}: ${room.id} - ${room.creator}${expired}`);
                } catch (e) {
                    log(`  - ${key}: ERROR`);
                }
            });
        }
        
        function probarGetAllRooms() {
            log('\nğŸ” Probando getAllRooms():');
            const rooms = app.getAllRooms();
            log(`Resultado: ${rooms.length} salas encontradas`);
            rooms.forEach((room, i) => {
                const expired = app.isRoomExpired(room) ? 'EXPIRADA' : 'ACTIVA';
                log(`  ${i+1}. ${room.id} - ${room.creator} - ${expired}`);
            });
        }
        
        function probarGetAllRoomsAdmin() {
            log('\nğŸ” Probando getAllRooms(true):');
            const rooms = app.getAllRooms(true);
            log(`Resultado: ${rooms.length} salas encontradas`);
            rooms.forEach((room, i) => {
                const expired = app.isRoomExpired(room) ? 'EXPIRADA' : 'ACTIVA';
                log(`  ${i+1}. ${room.id} - ${room.creator} - ${expired}`);
            });
            
            // Simular lo que hace adminListRooms
            log('\nğŸ¯ Simulando adminListRooms():');
            if (rooms.length === 0) {
                log('âŒ No hay salas - se mostrarÃ­a modal vacÃ­o');
            } else {
                log('âœ… Hay salas - se generarÃ­a listado:');
                rooms.forEach((room, index) => {
                    const status = 'âœ… Activa';
                    const isExpired = app.isRoomExpired(room);
                    const timeStatus = isExpired ? ' (ExpirÃ³ naturalmente)' : ' (Dentro del tiempo)';
                    const messageCount = room.messages ? room.messages.length : 0;
                    
                    log(`${index + 1}. ${room.id}`);
                    log(`   Creador: ${room.creator}`);
                    log(`   Estado: ${status}${timeStatus}`);
                    log(`   Mensajes: ${messageCount}/${room.messageLimit}`);
                });
            }
        }
        
        function limpiar() {
            const keys = Object.keys(localStorage);
            const roomKeys = keys.filter(k => k.startsWith('room_'));
            roomKeys.forEach(key => localStorage.removeItem(key));
            log(`ğŸ—‘ï¸ Eliminadas ${roomKeys.length} salas`);
            output.textContent = '';
        }
        
        // NUEVAS FUNCIONES PARA TESTING DEL MODAL
        function activarAdmin() {
            log('\nğŸ”‘ Activando modo administrador...')
            app.state.isAdmin = true;
            log('âœ… Modo administrador activado');
        }
        
        async function testModalClick1() {
            log('\nğŸ‘† PRIMER CLICK EN adminListRooms()...');
            try {
                await app.adminListRooms();
                log('âœ… Primer click completado');
                setTimeout(() => {
                    inspeccionarModal();
                }, 1000);
            } catch (error) {
                log(`âŒ Error en primer click: ${error.message}`);
            }
        }
        
        async function testModalClick2() {
            log('\nğŸ‘† SEGUNDO CLICK EN adminListRooms()...');
            try {
                await app.adminListRooms();
                log('âœ… Segundo click completado');
                setTimeout(() => {
                    inspeccionarModal();
                }, 1000);
            } catch (error) {
                log(`âŒ Error en segundo click: ${error.message}`);
            }
        }
        
        async function testModalClick3() {
            log('\nğŸ‘† TERCER CLICK EN adminListRooms()...');
            try {
                await app.adminListRooms();
                log('âœ… Tercer click completado');
                setTimeout(() => {
                    inspeccionarModal();
                }, 1000);
            } catch (error) {
                log(`âŒ Error en tercer click: ${error.message}`);
            }
        }
        
        function inspeccionarModal() {
            const modal = document.getElementById('confirmModal');
            const message = document.getElementById('confirmMessage');
            const title = document.getElementById('confirmTitle');
            
            log('\nğŸ” INSPECCIÃ“N DEL MODAL:');
            log(`   Modal visible: ${!modal.classList.contains('hidden')}`);
            log(`   TÃ­tulo: "${title.textContent}"`);
            log(`   Contenido length: ${message.innerHTML.length} chars`);
            log(`   Primeros 150 chars: "${message.innerHTML.substring(0, 150)}"`);
            
            const deleteButtons = document.querySelectorAll('.admin-delete-btn');
            const reactivateButtons = document.querySelectorAll('.admin-reactivate-btn');
            log(`   Botones eliminar encontrados: ${deleteButtons.length}`);
            log(`   Botones reactivar encontrados: ${reactivateButtons.length}`);
            
            if (message.innerHTML.length < 50) {
                log('ğŸš¨ PROBLEMA DETECTADO: Contenido del modal muy corto!');
            }
        }
        
        // Auto-mostrar estado inicial
        setTimeout(() => {
            log('ğŸš€ Sistema cargado');
            mostrarStorage();
        }, 1000);
    </script>
</body>
</html>