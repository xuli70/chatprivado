<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>üîç Debug Storage Bucket - Chat An√≥nimo</title>
    <link rel="stylesheet" href="style.css">
    <style>
        body {
            padding: 2rem;
            font-family: system-ui, -apple-system, sans-serif;
            background: var(--color-bg);
            color: var(--color-text-1);
        }
        
        .debug-container {
            max-width: 1000px;
            margin: 0 auto;
        }
        
        .debug-section {
            background: var(--color-bg-card);
            border: 1px solid var(--color-border);
            border-radius: var(--radius-md);
            padding: var(--space-24);
            margin-bottom: var(--space-24);
        }
        
        .debug-title {
            color: var(--color-primary);
            margin-bottom: var(--space-16);
            font-size: 1.25rem;
            font-weight: 600;
        }
        
        .debug-button {
            background: var(--color-primary);
            color: white;
            border: none;
            padding: var(--space-8) var(--space-16);
            border-radius: var(--radius-sm);
            cursor: pointer;
            margin-right: var(--space-8);
            margin-bottom: var(--space-8);
        }
        
        .debug-button:hover {
            background: var(--color-primary-hover);
        }
        
        .debug-button.success {
            background: var(--color-success);
        }
        
        .debug-button.error {
            background: var(--color-error);
        }
        
        .debug-results {
            background: var(--color-bg-1);
            border: 1px solid var(--color-border);
            border-radius: var(--radius-sm);
            padding: var(--space-12);
            margin-top: var(--space-16);
            font-family: monospace;
            font-size: 0.9rem;
            max-height: 400px;
            overflow-y: auto;
            white-space: pre-wrap;
        }
        
        .status-indicator {
            display: inline-block;
            width: 12px;
            height: 12px;
            border-radius: 50%;
            margin-right: var(--space-8);
        }
        
        .status-success { background: var(--color-success); }
        .status-error { background: var(--color-error); }
        .status-warning { background: var(--color-warning); }
        .status-info { background: var(--color-primary); }
        
        .code-block {
            background: var(--color-bg-1);
            border: 1px solid var(--color-border);
            border-radius: var(--radius-sm);
            padding: var(--space-16);
            margin: var(--space-16) 0;
            font-family: monospace;
            font-size: 0.9rem;
            overflow-x: auto;
        }
    </style>
</head>
<body>
    <div class="debug-container">
        <h1>üîç Debug Storage Bucket - Chat An√≥nimo</h1>
        <p>Herramienta de diagn√≥stico para resolver el error "Bucket not found" en el sistema de PDFs.</p>
        
        <!-- Estado de Conexi√≥n -->
        <div class="debug-section">
            <h2 class="debug-title">üîó Estado de Conexi√≥n Supabase</h2>
            <div id="connectionStatus">
                <p><span class="status-indicator status-info"></span>Verificando conexi√≥n...</p>
            </div>
            <button class="debug-button" onclick="testSupabaseConnection()">üîÑ Test Conexi√≥n</button>
        </div>
        
        <!-- Diagn√≥stico de Buckets -->
        <div class="debug-section">
            <h2 class="debug-title">üóÉÔ∏è Diagn√≥stico de Storage Buckets</h2>
            <div id="bucketsStatus">
                <p>Haz clic en "Listar Buckets" para ver el estado actual</p>
            </div>
            <button class="debug-button" onclick="listAllBuckets()">üìã Listar Buckets</button>
            <button class="debug-button" onclick="testSpecificBucket()">üéØ Test Bucket 'chat-pdfs'</button>
            <button class="debug-button" onclick="testBucketPermissions()">üîê Test Permisos</button>
        </div>
        
        <!-- Test de Upload -->
        <div class="debug-section">
            <h2 class="debug-title">‚¨ÜÔ∏è Test de Upload</h2>
            <div id="uploadStatus">
                <p>Usa estos tests para verificar la funcionalidad de upload</p>
            </div>
            <button class="debug-button" onclick="testDirectUpload()">üì§ Test Upload Directo</button>
            <button class="debug-button" onclick="testPDFManagerUpload()">üìÑ Test PDF Manager</button>
            <button class="debug-button" onclick="simulateUploadFlow()">üé≠ Simular Flujo Completo</button>
        </div>
        
        <!-- Informaci√≥n del Sistema -->
        <div class="debug-section">
            <h2 class="debug-title">‚ÑπÔ∏è Informaci√≥n del Sistema</h2>
            <div id="systemInfo">
                <p>Cargando informaci√≥n del sistema...</p>
            </div>
            <button class="debug-button" onclick="getSystemInfo()">üîÑ Actualizar Info</button>
        </div>
        
        <!-- Soluciones Sugeridas -->
        <div class="debug-section">
            <h2 class="debug-title">üí° Soluciones Sugeridas</h2>
            <div id="suggestedFixes">
                <h4>Pasos para resolver "Bucket not found":</h4>
                <ol>
                    <li><strong>Verificar nombre del bucket</strong>: Debe ser exactamente "chat-pdfs" (min√∫sculas, con gui√≥n)</li>
                    <li><strong>Verificar que sea p√∫blico</strong>: El bucket debe estar marcado como "Public"</li>
                    <li><strong>Limpiar cach√©</strong>: Refrescar p√°gina completamente (Ctrl+F5)</li>
                    <li><strong>Verificar pol√≠ticas</strong>: Las pol√≠ticas RLS deben permitir acceso p√∫blico</li>
                </ol>
                
                <h4>SQL para crear bucket (si es necesario):</h4>
                <div class="code-block">
-- Crear bucket
INSERT INTO storage.buckets (id, name, public) 
VALUES ('chat-pdfs', 'chat-pdfs', true)
ON CONFLICT (id) DO NOTHING;

-- Pol√≠ticas de acceso
CREATE POLICY "chat_pdfs_public_read" ON storage.objects FOR SELECT USING (bucket_id = 'chat-pdfs');
CREATE POLICY "chat_pdfs_public_upload" ON storage.objects FOR INSERT WITH CHECK (bucket_id = 'chat-pdfs');
CREATE POLICY "chat_pdfs_public_update" ON storage.objects FOR UPDATE USING (bucket_id = 'chat-pdfs');
CREATE POLICY "chat_pdfs_public_delete" ON storage.objects FOR DELETE USING (bucket_id = 'chat-pdfs');
                </div>
            </div>
            <button class="debug-button" onclick="copyBucketSQL()">üìã Copiar SQL</button>
        </div>
        
        <!-- Log de Resultados -->
        <div class="debug-section">
            <h2 class="debug-title">üìù Log de Diagn√≥sticos</h2>
            <div id="debugLog" class="debug-results">
Iniciando diagn√≥stico del sistema de storage...
            </div>
            <button class="debug-button" onclick="clearLog()">üßπ Limpiar Log</button>
            <button class="debug-button" onclick="exportLog()">üíæ Exportar Log</button>
        </div>
    </div>

    <!-- Scripts -->
    <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>
    <script src="env.js"></script>
    <script src="supabase-client.js"></script>
    <script type="module">
        import { validatePDFFile, uploadPDF } from './js/modules/pdf-manager.js';
        
        let supabaseClient = null;
        let debugLog = [];
        
        // Inicializar debugging
        window.addEventListener('DOMContentLoaded', async () => {
            log('üîç Iniciando Debug Storage Bucket...');
            
            // Inicializar cliente Supabase
            try {
                supabaseClient = new SupabaseClient();
                await new Promise(resolve => setTimeout(resolve, 2000)); // Esperar inicializaci√≥n
                log('‚úÖ Cliente Supabase inicializado');
            } catch (error) {
                log(`‚ùå Error inicializando cliente: ${error.message}`);
            }
            
            // Mostrar informaci√≥n inicial del sistema
            getSystemInfo();
            
            // Test autom√°tico de conexi√≥n
            setTimeout(() => {
                testSupabaseConnection();
            }, 1000);
        });
        
        function log(message) {
            const timestamp = new Date().toLocaleTimeString();
            const logMessage = `[${timestamp}] ${message}`;
            debugLog.push(logMessage);
            
            const logDiv = document.getElementById('debugLog');
            logDiv.textContent += logMessage + '\n';
            logDiv.scrollTop = logDiv.scrollHeight;
            
            console.log(logMessage);
        }
        
        window.testSupabaseConnection = async function() {
            const statusDiv = document.getElementById('connectionStatus');
            statusDiv.innerHTML = '<p><span class="status-indicator status-info"></span>Verificando conexi√≥n...</p>';
            
            log('üîó Testing conexi√≥n Supabase...');
            
            try {
                if (!supabaseClient) {
                    throw new Error('Cliente Supabase no inicializado');
                }
                
                // Test configuraci√≥n
                log(`URL: ${supabaseClient.supabaseUrl}`);
                log(`Key: ${supabaseClient.supabaseKey ? supabaseClient.supabaseKey.substr(0, 20) + '...' : 'NO CONFIGURADA'}`);
                
                // Test disponibilidad
                const isAvailable = supabaseClient.isSupabaseAvailable();
                log(`Cliente disponible: ${isAvailable}`);
                
                if (!isAvailable) {
                    statusDiv.innerHTML = '<p><span class="status-indicator status-error"></span>Supabase no disponible - modo local</p>';
                    log('‚ùå Supabase no disponible, funcionando en modo local');
                    return;
                }
                
                // Test conexi√≥n real
                log('üß™ Testing query de prueba...');
                const { data, error } = await supabaseClient.client.from('chat_rooms').select('count').limit(1);
                
                if (error) {
                    throw new Error(`Error en query: ${error.message}`);
                }
                
                statusDiv.innerHTML = '<p><span class="status-indicator status-success"></span>Conexi√≥n exitosa</p>';
                log('‚úÖ Conexi√≥n a Supabase exitosa');
                
            } catch (error) {
                statusDiv.innerHTML = `<p><span class="status-indicator status-error"></span>Error: ${error.message}</p>`;
                log(`‚ùå Error conexi√≥n: ${error.message}`);
            }
        };
        
        window.listAllBuckets = async function() {
            const statusDiv = document.getElementById('bucketsStatus');
            statusDiv.innerHTML = 'Listando buckets...';
            
            log('üóÉÔ∏è Listando todos los buckets...');
            
            try {
                if (!supabaseClient || !supabaseClient.isSupabaseAvailable()) {
                    throw new Error('Supabase no disponible');
                }
                
                const { data: buckets, error } = await supabaseClient.client.storage.listBuckets();
                
                if (error) {
                    throw new Error(`Error listando buckets: ${error.message}`);
                }
                
                log(`üìã Encontrados ${buckets.length} buckets:`);
                
                let html = `<h4>Buckets encontrados (${buckets.length}):</h4><ul>`;
                
                buckets.forEach(bucket => {
                    const isTargetBucket = bucket.id === 'chat-pdfs';
                    const icon = isTargetBucket ? 'üéØ' : 'üìÅ';
                    const style = isTargetBucket ? 'font-weight: bold; color: var(--color-success);' : '';
                    
                    html += `<li style="${style}">${icon} <strong>${bucket.id}</strong> - ${bucket.name} (P√∫blico: ${bucket.public ? '‚úÖ' : '‚ùå'})</li>`;
                    log(`  ${icon} ${bucket.id} - ${bucket.name} (p√∫blico: ${bucket.public})`);
                });
                
                html += '</ul>';
                
                const chatPdfsBucket = buckets.find(b => b.id === 'chat-pdfs');
                if (chatPdfsBucket) {
                    html += '<p><span class="status-indicator status-success"></span><strong>¬°Bucket "chat-pdfs" encontrado!</strong></p>';
                    html += `<p>Configuraci√≥n: P√∫blico = ${chatPdfsBucket.public ? '‚úÖ S√ç' : '‚ùå NO'}</p>`;
                    log('‚úÖ Bucket "chat-pdfs" encontrado y configurado');
                } else {
                    html += '<p><span class="status-indicator status-error"></span><strong>Bucket "chat-pdfs" NO encontrado</strong></p>';
                    html += '<p>El bucket necesita ser creado manualmente desde el Dashboard de Supabase</p>';
                    log('‚ùå Bucket "chat-pdfs" NO encontrado - necesita ser creado');
                }
                
                statusDiv.innerHTML = html;
                
            } catch (error) {
                statusDiv.innerHTML = `<p><span class="status-indicator status-error"></span>Error: ${error.message}</p>`;
                log(`‚ùå Error listando buckets: ${error.message}`);
            }
        };
        
        window.testSpecificBucket = async function() {
            log('üéØ Testing bucket espec√≠fico "chat-pdfs"...');
            
            try {
                if (!supabaseClient || !supabaseClient.isSupabaseAvailable()) {
                    throw new Error('Supabase no disponible');
                }
                
                // Test 1: Listar archivos en el bucket
                log('üìÅ Intentando listar archivos en chat-pdfs...');
                const { data: files, error: listError } = await supabaseClient.client.storage
                    .from('chat-pdfs')
                    .list('', { limit: 5 });
                
                if (listError) {
                    if (listError.message.includes('Bucket not found')) {
                        log('‚ùå CONFIRMADO: Bucket "chat-pdfs" no existe');
                        document.getElementById('bucketsStatus').innerHTML += 
                            `<p><span class="status-indicator status-error"></span><strong>DIAGN√ìSTICO: Bucket "chat-pdfs" no existe</strong></p>
                             <p>Soluci√≥n: Crear bucket desde Dashboard de Supabase</p>`;
                    } else {
                        log(`‚ö†Ô∏è Error listando archivos: ${listError.message}`);
                    }
                } else {
                    log(`‚úÖ Bucket existe - contiene ${files.length} archivos`);
                    document.getElementById('bucketsStatus').innerHTML += 
                        `<p><span class="status-indicator status-success"></span>Bucket "chat-pdfs" existe y es accesible</p>`;
                }
                
            } catch (error) {
                log(`‚ùå Error testing bucket: ${error.message}`);
            }
        };
        
        window.testBucketPermissions = async function() {
            log('üîê Testing permisos del bucket...');
            
            try {
                if (!supabaseClient || !supabaseClient.isSupabaseAvailable()) {
                    throw new Error('Supabase no disponible');
                }
                
                // Test obtener URL p√∫blica
                log('üåê Testing URL p√∫blica...');
                const { data: urlData } = supabaseClient.client.storage
                    .from('chat-pdfs')
                    .getPublicUrl('test-file.pdf');
                
                if (urlData && urlData.publicUrl) {
                    log(`‚úÖ URL p√∫blica generada: ${urlData.publicUrl}`);
                } else {
                    log('‚ö†Ô∏è No se pudo generar URL p√∫blica');
                }
                
            } catch (error) {
                log(`‚ùå Error testing permisos: ${error.message}`);
            }
        };
        
        window.testDirectUpload = async function() {
            log('üì§ Testing upload directo a Storage...');
            
            try {
                if (!supabaseClient || !supabaseClient.isSupabaseAvailable()) {
                    throw new Error('Supabase no disponible');
                }
                
                // Crear archivo de prueba
                const testContent = 'Test PDF content for debugging';
                const testFile = new File([testContent], 'debug-test.pdf', { type: 'application/pdf' });
                
                log(`üìÑ Creado archivo de prueba: ${testFile.name} (${testFile.size} bytes)`);
                
                // Intentar upload directo
                const fileName = `debug-${Date.now()}.pdf`;
                log(`‚¨ÜÔ∏è Intentando upload como: ${fileName}`);
                
                const { data, error } = await supabaseClient.client.storage
                    .from('chat-pdfs')
                    .upload(fileName, testFile, {
                        cacheControl: '3600',
                        upsert: false
                    });
                
                if (error) {
                    if (error.message.includes('Bucket not found')) {
                        log('‚ùå CONFIRMADO: Error "Bucket not found" en upload directo');
                        document.getElementById('uploadStatus').innerHTML = 
                            `<p><span class="status-indicator status-error"></span><strong>Bucket "chat-pdfs" no existe</strong></p>
                             <p>El error se reproduce en upload directo</p>`;
                    } else {
                        log(`‚ùå Error upload: ${error.message}`);
                    }
                } else {
                    log(`‚úÖ Upload exitoso: ${data.path}`);
                    document.getElementById('uploadStatus').innerHTML = 
                        `<p><span class="status-indicator status-success"></span>Upload directo exitoso</p>`;
                    
                    // Limpiar archivo de prueba
                    setTimeout(async () => {
                        await supabaseClient.client.storage.from('chat-pdfs').remove([fileName]);
                        log('üßπ Archivo de prueba eliminado');
                    }, 2000);
                }
                
            } catch (error) {
                log(`‚ùå Error en test upload: ${error.message}`);
            }
        };
        
        window.testPDFManagerUpload = async function() {
            log('üìÑ Testing PDF Manager upload...');
            
            try {
                // Crear archivo de prueba
                const testContent = 'PDF Manager test content';
                const testFile = new File([testContent], 'pdf-manager-test.pdf', { type: 'application/pdf' });
                
                log(`üìÑ Testing validaci√≥n...`);
                const validation = validatePDFFile(testFile);
                if (!validation.isValid) {
                    throw new Error(`Validaci√≥n fall√≥: ${validation.error}`);
                }
                log('‚úÖ Validaci√≥n OK');
                
                log(`‚¨ÜÔ∏è Testing upload con PDF Manager...`);
                const result = await uploadPDF(testFile, 'DEBUG_TEST', 'Debug User', supabaseClient);
                
                log(`‚úÖ PDF Manager upload exitoso:`);
                log(`  ID: ${result.id}`);
                log(`  URL: ${result.url}`);
                
                document.getElementById('uploadStatus').innerHTML += 
                    `<p><span class="status-indicator status-success"></span>PDF Manager upload exitoso</p>`;
                
            } catch (error) {
                if (error.message.includes('Bucket not found')) {
                    log('‚ùå CONFIRMADO: PDF Manager tambi√©n recibe "Bucket not found"');
                    document.getElementById('uploadStatus').innerHTML += 
                        `<p><span class="status-indicator status-error"></span>PDF Manager confirma: Bucket no existe</p>`;
                } else {
                    log(`‚ùå Error PDF Manager: ${error.message}`);
                }
            }
        };
        
        window.simulateUploadFlow = async function() {
            log('üé≠ Simulando flujo completo de upload...');
            
            // Este test simula el flujo sin usar Supabase para verificar que el c√≥digo funciona
            try {
                const testFile = new File(['simulation'], 'simulate.pdf', { type: 'application/pdf' });
                
                // Simular con cliente null (forzar modo local)
                const result = await uploadPDF(testFile, 'SIMULATION', 'Sim User', null);
                
                log('‚úÖ Simulaci√≥n exitosa:');
                log(`  ID: ${result.id}`);
                log(`  Path: ${result.file_path}`);
                log('üí° El c√≥digo PDF Manager funciona correctamente en modo simulaci√≥n');
                
                document.getElementById('uploadStatus').innerHTML += 
                    `<p><span class="status-indicator status-success"></span>Simulaci√≥n de flujo exitosa</p>`;
                
            } catch (error) {
                log(`‚ùå Error en simulaci√≥n: ${error.message}`);
            }
        };
        
        window.getSystemInfo = function() {
            const infoDiv = document.getElementById('systemInfo');
            
            const info = {
                userAgent: navigator.userAgent,
                online: navigator.onLine,
                url: window.location.href,
                supabaseUrl: supabaseClient?.supabaseUrl || 'No configurada',
                supabaseKey: supabaseClient?.supabaseKey ? 'Configurada (****)' : 'No configurada',
                supabaseAvailable: supabaseClient?.isSupabaseAvailable() || false,
                timestamp: new Date().toISOString()
            };
            
            let html = '<h4>Informaci√≥n del Sistema:</h4><ul>';
            Object.entries(info).forEach(([key, value]) => {
                html += `<li><strong>${key}:</strong> ${value}</li>`;
            });
            html += '</ul>';
            
            infoDiv.innerHTML = html;
            
            log('‚ÑπÔ∏è Sistema info actualizada');
        };
        
        window.copyBucketSQL = function() {
            const sql = `-- Crear bucket
INSERT INTO storage.buckets (id, name, public) 
VALUES ('chat-pdfs', 'chat-pdfs', true)
ON CONFLICT (id) DO NOTHING;

-- Pol√≠ticas de acceso
CREATE POLICY "chat_pdfs_public_read" ON storage.objects FOR SELECT USING (bucket_id = 'chat-pdfs');
CREATE POLICY "chat_pdfs_public_upload" ON storage.objects FOR INSERT WITH CHECK (bucket_id = 'chat-pdfs');
CREATE POLICY "chat_pdfs_public_update" ON storage.objects FOR UPDATE USING (bucket_id = 'chat-pdfs');
CREATE POLICY "chat_pdfs_public_delete" ON storage.objects FOR DELETE USING (bucket_id = 'chat-pdfs');`;
            
            navigator.clipboard.writeText(sql).then(() => {
                log('üìã SQL copiado al portapapeles');
                alert('SQL copiado al portapapeles. P√©galo en el SQL Editor de Supabase.');
            }).catch(() => {
                log('‚ùå Error copiando SQL');
                alert('Error copiando. SQL mostrado en consola.');
                console.log(sql);
            });
        };
        
        window.clearLog = function() {
            debugLog = [];
            document.getElementById('debugLog').textContent = 'Log limpiado...\n';
            log('üßπ Log limpiado');
        };
        
        window.exportLog = function() {
            const logContent = debugLog.join('\n');
            const blob = new Blob([logContent], { type: 'text/plain' });
            const url = URL.createObjectURL(blob);
            
            const a = document.createElement('a');
            a.href = url;
            a.download = `storage-debug-${new Date().toISOString().slice(0,16)}.txt`;
            document.body.appendChild(a);
            a.click();
            document.body.removeChild(a);
            URL.revokeObjectURL(url);
            
            log('üíæ Log exportado');
        };
        
        // Hacer disponible globalmente para debugging
        window.supabaseClient = supabaseClient;
        window.debugLog = debugLog;
        
        log('üîç Debug Storage Bucket listo');
    </script>
</body>
</html>