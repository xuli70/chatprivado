<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>üîç Debug Admin Modal - An√°lisis Detallado</title>
    <link rel="stylesheet" href="style.css">
</head>
<body>
    <div class="container">
        <h1>üîç Debug: "Ver Salas Existentes"</h1>
        
        <div class="debug-section">
            <h2>Estado Actual del Sistema</h2>
            <div id="systemStatus" class="status-display"></div>
        </div>
        
        <div class="debug-section">
            <h2>üß™ Test Paso a Paso</h2>
            <button onclick="step1_CreateTestData()" class="btn btn--primary">1Ô∏è‚É£ Crear Datos Test</button>
            <button onclick="step2_InitializeApp()" class="btn btn--primary">2Ô∏è‚É£ Inicializar App</button>
            <button onclick="step3_ActivateAdmin()" class="btn btn--primary">3Ô∏è‚É£ Activar Admin</button>
            <button onclick="step4_FirstClick()" class="btn btn--secondary">4Ô∏è‚É£ Primer Click "Ver Salas"</button>
            <button onclick="step5_SecondClick()" class="btn btn--secondary">5Ô∏è‚É£ Segundo Click "Ver Salas"</button>
            <button onclick="step6_ThirdClick()" class="btn btn--secondary">6Ô∏è‚É£ Tercer Click "Ver Salas"</button>
        </div>
        
        <div class="debug-section">
            <h2>üìä Modal State Inspector</h2>
            <button onclick="inspectModal()" class="btn btn--outline">üîç Inspeccionar Modal</button>
            <button onclick="inspectEventListeners()" class="btn btn--outline">üëÇ Ver Event Listeners</button>
            <button onclick="manualCleanup()" class="btn btn--danger">üßπ Limpieza Manual</button>
        </div>
        
        <div id="debugLog" class="debug-log"></div>
    </div>

    <!-- Modal exacto del index.html -->
    <div id="confirmModal" class="modal hidden">
        <div class="modal-content">
            <div class="modal-header">
                <h3 id="confirmTitle">Confirmar acci√≥n</h3>
            </div>
            <div class="modal-body">
                <p id="confirmMessage">¬øEst√°s seguro?</p>
            </div>
            <div class="modal-footer">
                <button id="cancelBtn" class="btn btn--outline">Cancelar</button>
                <button id="confirmBtn" class="btn btn--primary">Confirmar</button>
            </div>
        </div>
    </div>

    <script src="env.js"></script>
    <script src="supabase-client.js"></script>
    <script src="app.js"></script>
    <script>
        // Crear instancia de la app para testing
        const app = new AnonymousChatApp();
        const output = document.getElementById('output');
        
        function log(message) {
            output.textContent += new Date().toLocaleTimeString() + ' - ' + message + '\n';
            console.log(message);
        }
        
        function crearSalaDePrueba() {
            const roomId = 'TEST' + Math.floor(Math.random() * 1000);
            const room = {
                id: roomId,
                creator: 'Admin Test',
                question: 'Sala de prueba para debugging',
                createdAt: new Date().toISOString(),
                expiresAt: new Date(Date.now() + 7200000).toISOString(), // 2 horas
                messageLimit: 200,
                messages: [{
                    id: Date.now(),
                    text: 'Mensaje de prueba',
                    isAnonymous: false,
                    author: 'Admin Test',
                    timestamp: new Date().toISOString(),
                    votes: { likes: 0, dislikes: 0 }
                }]
            };
            
            localStorage.setItem(`room_${roomId}`, JSON.stringify(room));
            log(`‚úÖ Sala creada: ${roomId}`);
        }
        
        function crearVariasSalas() {
            for(let i = 1; i <= 3; i++) {
                setTimeout(() => crearSalaDePrueba(), i * 100);
            }
        }
        
        function testGetAllRooms() {
            const rooms = app.getAllRooms();
            log(`üìã getAllRooms() encontr√≥: ${rooms.length} salas`);
            rooms.forEach((room, index) => {
                log(`  ${index + 1}. ${room.id} - ${room.creator} - ${room.messages?.length || 0} mensajes`);
            });
        }
        
        function testGetAllRoomsAdmin() {
            const rooms = app.getAllRooms(true);
            log(`üìã getAllRooms(true) encontr√≥: ${rooms.length} salas`);
            rooms.forEach((room, index) => {
                const expired = app.isRoomExpired(room) ? ' (EXPIRADA)' : ' (ACTIVA)';
                log(`  ${index + 1}. ${room.id} - ${room.creator}${expired} - ${room.messages?.length || 0} mensajes`);
            });
        }
        
        function testAdminListRooms() {
            log('üîç Ejecutando adminListRooms()...');
            app.adminListRooms();
        }
        
        function mostrarLocalStorage() {
            log('üíæ Contenido de localStorage:');
            const keys = Object.keys(localStorage);
            const roomKeys = keys.filter(key => key.startsWith('room_'));
            log(`  Total de claves: ${keys.length}`);
            log(`  Claves de salas: ${roomKeys.length}`);
            
            roomKeys.forEach(key => {
                try {
                    const room = JSON.parse(localStorage.getItem(key));
                    log(`  - ${key}: ${room.id} (${room.creator})`);
                } catch (error) {
                    log(`  - ${key}: ERROR al parsear`);
                }
            });
        }
        
        function limpiarTodo() {
            const keys = Object.keys(localStorage);
            const roomKeys = keys.filter(key => key.startsWith('room_'));
            roomKeys.forEach(key => localStorage.removeItem(key));
            log(`üóëÔ∏è Eliminadas ${roomKeys.length} salas de localStorage`);
            output.textContent = '';
        }
        
        // Auto-mostrar informaci√≥n inicial
        setTimeout(() => {
            log('üöÄ Sistema de debugging cargado');
            mostrarLocalStorage();
        }, 1000);
    </script>
    
    <style>
        .debug-section {
            margin: 20px 0;
            padding: 15px;
            border: 2px solid #007bff;
            border-radius: 8px;
            background: #f8f9fa;
        }
        
        .status-display {
            background: #e9ecef;
            padding: 10px;
            border-radius: 4px;
            font-family: 'Courier New', monospace;
            font-size: 14px;
        }
        
        .debug-log {
            margin-top: 20px;
            padding: 15px;
            background: #1a1a1a;
            color: #00ff00;
            border-radius: 8px;
            font-family: 'Courier New', monospace;
            font-size: 12px;
            max-height: 500px;
            overflow-y: auto;
            border: 2px solid #333;
        }
        
        .debug-entry {
            margin: 2px 0;
            padding: 1px 0;
            display: flex;
            align-items: center;
        }
        
        .step-number {
            color: #ff6b6b;
            font-weight: bold;
            margin-right: 5px;
            min-width: 40px;
        }
        
        .timestamp {
            color: #888;
            font-size: 0.9em;
            margin-right: 8px;
            min-width: 80px;
        }
        
        .content {
            flex: 1;
        }
        
        .debug-info { color: #00ff00; }
        .debug-success { color: #00ff88; font-weight: bold; }
        .debug-error { color: #ff4444; font-weight: bold; }
        
        button {
            margin: 5px;
        }
        
        h1 {
            color: #007bff;
            text-align: center;
        }
        
        h2 {
            color: #495057;
            border-bottom: 2px solid #dee2e6;
            padding-bottom: 5px;
        }
    </style>
</body>
</html>